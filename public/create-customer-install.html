<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Install for New Customer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/styles.css" />
  <script src="/js/stateDropdown.js"></script>
</head>
<body>
  <div class="page-container">
    <div class="form-wrapper">
      <h2>Create Install for New Customer</h2>

      <form id="mainForm" action="/installs/create-customer-install" method="POST">
        <div class="form-columns">

          <!-- Left Column: Customer Info -->
          <div class="form-section">
            <h3>Customer Info</h3>
            <div class="form-row"><label for="first_name">First Name:</label><input name="first_name" id="first_name" required /></div>
            <div class="form-row"><label for="last_name">Last Name:</label><input name="last_name" id="last_name" required /></div>
            <div class="form-row"><label for="address">Address:</label><input name="address" id="address"/></div>
            <div class="form-row"><label for="city">City:</label><input name="city" id="city"/></div>
            <div class="form-row"><label for="state">State:</label><select name="state" id="state" required></select></div>
            <div class="form-row"><label for="zip">ZIP Code:</label><input name="zip" id="zip"/></div>
            <div class="form-row"><label for="phone">Phone Number:</label><input name="phone" id="phone" required/></div>
            <div class="form-row"><label for="email">Email:</label><input name="email" id="email" type="email"/></div>
            <div class="form-row"><label for="notes">Customer Notes:</label><textarea name="notes" id="notes"></textarea></div>
          </div>

          <!-- Right Column: Install Info -->
          <div class="form-section">
            <h3>Install Info</h3>
            <div class="form-row"><label for="description">Description:</label><input name="description" id="description" required /></div>
            
            <!-- Item Selection -->
            <h4 style="margin-top: 20px;">Add Items (Optional)</h4>
            <div class="form-row">
              <label for="itemSearch">Search Items:</label>
              <input type="text" id="itemSearch" placeholder="Search for items..." />
            </div>
            <div class="form-row">
              <select id="itemResults" style="width: 60%;">
                <option value="">Select an item...</option>
              </select>
              <input type="number" id="itemQuantity" value="1" min="1" style="width: 15%; margin-left: 10px;" placeholder="Qty" />
              <button type="button" id="addItemBtn" style="margin-left: 10px;">Add Item</button>
            </div>
            
            <!-- Selected Items Display -->
            <div id="selectedItemsContainer" style="margin-top: 15px; display: none;">
              <h5>Selected Items:</h5>
              <div id="selectedItemsList" style="background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                <!-- Items will be listed here -->
              </div>
              <div style="text-align: right; margin-top: 10px;">
                <strong>Items Total: <span id="itemsTotal">$0.00</span></strong>
              </div>
            </div>
            
            <div class="form-row" style="margin-top: 15px;">
              <label for="estimate">Labor Cost ($):</label>
              <input name="estimate" id="estimate" type="number" step="0.01" required />
            </div>
            <div class="form-row">
              <label>Total Install Cost:</label>
              <input id="totalCost" type="text" value="$0.00" disabled style="background-color: #e9ecef; font-weight: bold;" />
            </div>
            <div class="form-row"><label for="install_date">Install Date:</label><input name="install_date" id="install_date" type="date" required /></div>
            <div class="form-row"><label for="install_notes">Install Notes:</label><textarea name="install_notes" id="install_notes"></textarea></div>
          </div>

        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button type="reset">Clear Form</button>
          <button type="button" id="previewBtn">Complete Install</button>
          <button type="button" onclick="location.href='index.html'">‚¨ÖÔ∏è Back to Home</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Message Section -->
  <div id="successMessage" style="display: none;" class="page-container">
    <div class="form-wrapper">
      <div id="installDetails"></div>
    </div>
  </div>

  <!-- Utility Scripts -->
  <script src="/js/utils/shared-utils.js"></script>
  <script src="/js/utils/print-utils.js"></script>
  <script src="/js/utils/customer-search.js"></script>

  <script>
    // Initialize variables
    let selectedItems = [];

    function debounce(fn, delay = 300) {
      let timer;
      return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    // Item search function
    async function searchItems() {
      const searchInput = document.getElementById('itemSearch');
      const resultsSelect = document.getElementById('itemResults');
      
      const query = searchInput.value.trim();
      if (query.length < 2) {
        resultsSelect.innerHTML = '<option value="">Select an item...</option>';
        return;
      }

      try {
        const response = await fetch(`/api/items/search?q=${encodeURIComponent(query)}&type=install`);
        const items = await response.json();

        resultsSelect.innerHTML = '<option value="">Select an item...</option>';
        items.forEach(item => {
          const option = document.createElement('option');
          option.value = JSON.stringify({
            item_id: item.item_id,
            item_name: item.item_name,
            item_color: item.item_color,
            item_model: item.item_model,
            price: item.price
          });
          const price = parseFloat(item.price) || 0;
          option.textContent = `${item.item_name} - ${item.item_color} - ${item.item_model} ($${price.toFixed(2)})`;
          resultsSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error searching items:', error);
        resultsSelect.innerHTML = '<option value="">Error loading items</option>';
      }
    }

    // Add item function
    function addItem() {
      const itemSelect = document.getElementById('itemResults');
      const quantityInput = document.getElementById('itemQuantity');
      
      if (!itemSelect.value || !quantityInput.value || parseInt(quantityInput.value) <= 0) {
        alert('Please select an item and enter a valid quantity');
        return;
      }

      const itemData = JSON.parse(itemSelect.value);
      const quantity = parseInt(quantityInput.value);

      // Check if item already exists
      const existingIndex = selectedItems.findIndex(item => item.item_id === itemData.item_id);
      if (existingIndex !== -1) {
        selectedItems[existingIndex].quantity += quantity;
      } else {
        selectedItems.push({
          item_id: itemData.item_id,
          item_name: itemData.item_name,
          item_color: itemData.item_color,
          item_model: itemData.item_model,
          price: itemData.price,
          quantity: quantity
        });
      }

      // Reset form
      itemSelect.value = '';
      quantityInput.value = '1';
      document.getElementById('itemSearch').value = '';

      updateItemsDisplay();
      updateTotalCost();
    }

    // Remove item function
    function removeItem(index) {
      selectedItems.splice(index, 1);
      updateItemsDisplay();
      updateTotalCost();
    }

    // Update items display
    function updateItemsDisplay() {
      const container = document.getElementById('selectedItemsContainer');
      const itemsList = document.getElementById('selectedItemsList');

      if (selectedItems.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      itemsList.innerHTML = selectedItems.map((item, index) => {
        const price = parseFloat(item.price) || 0;
        const total = price * item.quantity;
        return `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #ddd;">
            <div>
              <strong>${item.item_name}</strong> - ${item.item_color} - ${item.item_model}<br>
              <small>$${price.toFixed(2)} √ó ${item.quantity} = $${total.toFixed(2)}</small>
            </div>
            <button onclick="removeItem(${index})" style="background-color: #dc3545; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer;">Remove</button>
          </div>
        `;
      }).join('');

      const itemsTotal = selectedItems.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
      document.getElementById('itemsTotal').textContent = `$${itemsTotal.toFixed(2)}`;
    }

    // Update total cost
    function updateTotalCost() {
      const itemsTotal = selectedItems.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
      const laborCost = parseFloat(document.getElementById('estimate').value) || 0;
      const totalCost = itemsTotal + laborCost;

      document.getElementById('totalCost').value = `$${totalCost.toFixed(2)}`;
    }

    // Show success summary
    function showSimpleInstallSuccess(result) {
      // Hide the form
      document.querySelector('.page-container').style.display = 'none';
      
      const successSection = document.getElementById('successMessage');
      const detailsDiv = document.getElementById('installDetails');
      
      // Get form data
      const formData = new FormData(document.getElementById('mainForm'));
      const customerName = `${formData.get('first_name')} ${formData.get('last_name')}`;
      const customerPhone = formData.get('phone');
      const customerEmail = formData.get('email') || 'N/A';
      const customerAddress = `${formData.get('address') || ''}, ${formData.get('city') || ''}, ${formData.get('state') || ''} ${formData.get('zip') || ''}`.trim();
      const description = formData.get('description');
      const laborCost = parseFloat(formData.get('estimate')) || 0;
      const installDate = formData.get('install_date') ? new Date(formData.get('install_date')) : new Date();
      
      // Calculate totals
      const itemsTotal = selectedItems.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
      const totalCost = itemsTotal + laborCost;
      
      // Build items HTML
      let itemsHTML = '';
      if (selectedItems.length > 0) {
        itemsHTML = `
          <h3 style="color: #333; margin-top: 20px;">Install Items:</h3>
          <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
              <tr style="background-color: #f8f9fa;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Item</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Qty</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Price</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Total</th>
              </tr>
            </thead>
            <tbody>
              ${selectedItems.map(item => {
                const price = parseFloat(item.price);
                const total = price * item.quantity;
                return `
                  <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">${item.item_name} - ${item.item_color} - ${item.item_model}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.quantity}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${price.toFixed(2)}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${total.toFixed(2)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
            <tfoot>
              <tr style="background-color: #f8f9fa; font-weight: bold;">
                <td colspan="3" style="border: 1px solid #ddd; padding: 8px; text-align: right;">Items Subtotal:</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${itemsTotal.toFixed(2)}</td>
              </tr>
            </tfoot>
          </table>
        `;
      }
      
      detailsDiv.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <h2 style="color: #28a745; text-align: center; margin-bottom: 20px;">‚úÖ Install Created Successfully!</h2>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <h3 style="color: #333; border-bottom: 2px solid #28a745; padding-bottom: 5px;">Install Information</h3>
              <p><strong>Install ID:</strong> #${result.install_id}</p>
              <p><strong>Description:</strong> ${description}</p>
              <p><strong>Scheduled Date:</strong> ${installDate.toLocaleDateString()}</p>
              <p><strong>Status:</strong> <span style="background: #ffc107; padding: 2px 8px; border-radius: 4px; color: black;">Scheduled</span></p>
            </div>
            
            <div>
              <h3 style="color: #333; border-bottom: 2px solid #17a2b8; padding-bottom: 5px;">Customer Details</h3>
              <p><strong>Name:</strong> ${customerName}</p>
              <p><strong>Phone:</strong> ${customerPhone}</p>
              <p><strong>Email:</strong> ${customerEmail}</p>
              <p><strong>Address:</strong> ${customerAddress}</p>
            </div>
          </div>
          
          ${itemsHTML}
          
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px;">
            <h3 style="color: #333; margin-bottom: 10px;">Cost Breakdown:</h3>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>Labor Cost:</span>
              <span><strong>$${laborCost.toFixed(2)}</strong></span>
            </div>
            ${selectedItems.length > 0 ? `
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>Items Total:</span>
                <span><strong>$${itemsTotal.toFixed(2)}</strong></span>
              </div>
            ` : ''}
            <hr style="margin: 10px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #28a745;">
              <span>Total Install Cost:</span>
              <span>$${totalCost.toFixed(2)}</span>
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button onclick="printSimpleInstallSummary()" style="background-color: #17a2b8; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin-right: 10px; font-size: 16px;">
              üñ®Ô∏è Print Install Summary
            </button>
            <button onclick="createAnotherSimpleInstall()" style="background-color: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin-right: 10px; font-size: 16px;">
              ‚ûï Create Another Install
            </button>
            <a href="install-summary.html" style="background-color: #6c757d; color: white; text-decoration: none; padding: 12px 24px; border-radius: 5px; font-size: 16px;">
              üìã View All Installs
            </a>
          </div>
        </div>
      `;
      
      successSection.style.display = 'block';
    }

    // Print function for simple install
    function printSimpleInstallSummary() {
      const summaryContent = document.getElementById('installDetails').innerHTML;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Install Summary</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              margin: 20px; 
              color: #333;
            }
            h2, h3 { 
              color: #333; 
            }
            table { 
              width: 100%; 
              border-collapse: collapse; 
              margin: 10px 0;
            }
            th, td { 
              border: 1px solid #ddd; 
              padding: 8px; 
              text-align: left;
            }
            th { 
              background-color: #f8f9fa; 
            }
            @media print {
              button, a { display: none; }
            }
          </style>
        </head>
        <body>
          ${summaryContent}
          <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
            Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
        }, 250);
      };
    }

    // Create another install function
    function createAnotherSimpleInstall() {
      // Reset everything
      selectedItems = [];
      
      // Reset form
      document.getElementById('mainForm').reset();
      
      // Hide success and show form
      document.getElementById('successMessage').style.display = 'none';
      document.querySelector('.page-container').style.display = 'block';
      
      // Reset displays
      updateItemsDisplay();
      updateTotalCost();
    }

    document.addEventListener('DOMContentLoaded', function() {
      populateStateDropdown('state');
      
      // Add event listeners
      document.getElementById('itemSearch').addEventListener('input', debounce(searchItems, 300));
      document.getElementById('addItemBtn').addEventListener('click', addItem);
      document.getElementById('estimate').addEventListener('input', updateTotalCost);
      
      // Add preview button handler
      document.getElementById('previewBtn').addEventListener('click', function(e) {
        e.preventDefault();
        // Trigger form submission
        document.getElementById('mainForm').dispatchEvent(new Event('submit'));
      });
      
      // Override form submission to include items
      const form = document.getElementById('mainForm');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
          data[key] = value;
        }
        
        // Add items to the data
        data.items = selectedItems;
        
        // Submit to server
        fetch('/installs/create-customer-install', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
          if (result.message && result.message.includes('created')) {
            showSimpleInstallSuccess(result);
          } else {
            alert('Error creating install: ' + (result.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error creating install. Please try again.');
        });
      });
    });
  </script>
</body>
</html>
